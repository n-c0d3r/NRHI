#pragma once

/** @file nrhi/utilities/platform_object_pool.hpp
*
*   Implement platform object pool.
*/



//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////



#pragma region Includes

////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////

#include <nrhi/prerequisites.hpp>

#pragma endregion



namespace nrhi {

	class A_device;



	namespace utilities {

		template<class F_pool__, typename F_platform_object__, typename F_input__>
		class TF_platform_object_pool {

		public:
			using F_pool = F_pool__;
			using F_platform_object = F_platform_object__;
			using F_input = F_input__;

		public:
			struct F_platform_object_wrapper {
				F_platform_object object;
				u64 counter = 0;
			};
			using F_platform_object_wrapper_map = TG_map<u64, F_platform_object_wrapper>;

#ifdef NRHI_THREAD_SAFE
		private:
			F_spin_lock spin_lock_;
#endif



		public:
			static inline void initialize() {

				F_pool__::map.clear();
			}
			static inline void release() {

				F_pool__::map.clear();
			}



		private:
			static NCPP_FORCE_INLINE u64 hash_input(const F_input& input) {

				return TF_hash_type_memory<F_input>()(input);
			}

		public:
			static inline F_platform_object acquire_object(TKPA_valid<A_device> device_p, const F_input& input) {

				u64 id = hash_input(input);
				F_platform_object result;

#ifdef NRHI_THREAD_SAFE
				spin_lock_.lock();
#endif

				auto it = F_pool::map.find(id);

				if(it != F_pool::map.end()) {
					auto& wrapper = it->second;
					result = wrapper.object;
					++(wrapper.counter);
				}
				else
				{
					result = F_pool::create_object(device_p, input);
					F_pool::map[id] = F_platform_object_wrapper{
						.object = result,
						.counter = 1
					};
				}

#ifdef NRHI_THREAD_SAFE
				spin_lock_.unlock();
#endif

				return result;
			}
			static inline void release_object(TKPA_valid<A_device> device_p, const F_input& input) {

				u64 id = hash_input(input);

#ifdef NRHI_THREAD_SAFE
				spin_lock_.lock();
#endif

				auto it = F_pool::map.find(id);

				NCPP_ASSERT(it != F_pool::map.end()) << "invalid input, object not acquired";

				if(0 == (--(it->second.counter))) {

					F_pool::destroy_object(device_p, it->second.object, input);
				}

#ifdef NRHI_THREAD_SAFE
				spin_lock_.unlock();
#endif
			}

		};

#define NRHI_PLATFORM_OBJECT_POOL_GENERATED_BODY() \
			public:                                         \
				static F_platform_object_wrapper_map map;

#define NRHI_PLATFORM_OBJECT_POOL_DEFINE(...) \
			typename __VA_ARGS__::F_platform_object_wrapper_map __VA_ARGS__::map;

	}

}
